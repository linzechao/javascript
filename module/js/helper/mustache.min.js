define(function(){function d(a){return"function"==typeof a}function e(a){return a.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function f(a,b){return null!=a&&"object"==typeof a&&b in a}function h(a,b){return g.call(a,b)}function j(a){return!h(i,a)}function l(a){return String(a).replace(/[&<>"'\/]/g,function(a){return k[a]})}function r(b,d){function l(){if(i&&!k)for(;h.length;)delete g[h.pop()];else h=[];i=!1,k=!1}function x(a){if("string"==typeof a&&(a=a.split(n,2)),!c(a)||2!==a.length)throw new Error("Invalid tags: "+a);r=new RegExp(e(a[0])+"\\s*"),v=new RegExp("\\s*"+e(a[1])),w=new RegExp("\\s*"+e("}"+a[1]))}if(!b)return[];var r,v,w,f=[],g=[],h=[],i=!1,k=!1;x(d||a.tags);for(var z,A,B,C,D,E,y=new u(b);!y.eos();){if(z=y.pos,B=y.scanUntil(r))for(var F=0,G=B.length;G>F;++F)C=B.charAt(F),j(C)?h.push(g.length):k=!0,g.push(["text",C,z,z+1]),z+=1,"\n"===C&&l();if(!y.scan(r))break;if(i=!0,A=y.scan(q)||"name",y.scan(m),"="===A?(B=y.scanUntil(o),y.scan(o),y.scanUntil(v)):"{"===A?(B=y.scanUntil(w),y.scan(p),y.scanUntil(v),A="&"):B=y.scanUntil(v),!y.scan(v))throw new Error("Unclosed tag at "+y.pos);if(D=[A,B,z,y.pos],g.push(D),"#"===A||"^"===A)f.push(D);else if("/"===A){if(E=f.pop(),!E)throw new Error('Unopened section "'+B+'" at '+z);if(E[1]!==B)throw new Error('Unclosed section "'+E[1]+'" at '+z)}else"name"===A||"{"===A||"&"===A?k=!0:"="===A&&x(B)}if(E=f.pop())throw new Error('Unclosed section "'+E[1]+'" at '+y.pos);return t(s(g))}function s(a){for(var c,d,b=[],e=0,f=a.length;f>e;++e)c=a[e],c&&("text"===c[0]&&d&&"text"===d[0]?(d[1]+=c[1],d[3]=c[3]):(b.push(c),d=c));return b}function t(a){for(var e,f,b=[],c=b,d=[],g=0,h=a.length;h>g;++g)switch(e=a[g],e[0]){case"#":case"^":c.push(e),d.push(e),c=e[4]=[];break;case"/":f=d.pop(),f[5]=e[2],c=d.length>0?d[d.length-1][4]:b;break;default:c.push(e)}return b}function u(a){this.string=a,this.tail=a,this.pos=0}function v(a,b){this.view=a,this.cache={".":this.view},this.parent=b}function w(){this.cache={}}var a={},b=Object.prototype.toString,c=Array.isArray||function(a){return"[object Array]"===b.call(a)},g=RegExp.prototype.test,i=/\S/,k={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"},m=/\s*/,n=/\s+/,o=/\s*=/,p=/\s*\}/,q=/#|\^|\/|>|\{|&|=|!/;u.prototype.eos=function(){return""===this.tail},u.prototype.scan=function(a){var b=this.tail.match(a);if(!b||0!==b.index)return"";var c=b[0];return this.tail=this.tail.substring(c.length),this.pos+=c.length,c},u.prototype.scanUntil=function(a){var c,b=this.tail.search(a);switch(b){case-1:c=this.tail,this.tail="";break;case 0:c="";break;default:c=this.tail.substring(0,b),this.tail=this.tail.substring(b)}return this.pos+=c.length,c},v.prototype.push=function(a){return new v(a,this)},v.prototype.lookup=function(a){var c,b=this.cache;if(b.hasOwnProperty(a))c=b[a];else{for(var g,h,e=this,i=!1;e;){if(a.indexOf(".")>0)for(c=e.view,g=a.split("."),h=0;null!=c&&h<g.length;)h===g.length-1&&(i=f(c,g[h])),c=c[g[h++]];else c=e.view[a],i=f(e.view,a);if(i)break;e=e.parent}b[a]=c}return d(c)&&(c=c.call(this.view)),c},w.prototype.clearCache=function(){this.cache={}},w.prototype.parse=function(a,b){var c=this.cache,d=c[a];return null==d&&(d=c[a]=r(a,b)),d},w.prototype.render=function(a,b,c){var d=this.parse(a),e=b instanceof v?b:new v(b);return this.renderTokens(d,e,c,a)},w.prototype.renderTokens=function(a,b,c,d){for(var f,g,h,e="",i=0,j=a.length;j>i;++i)h=void 0,f=a[i],g=f[0],"#"===g?h=this.renderSection(f,b,c,d):"^"===g?h=this.renderInverted(f,b,c,d):">"===g?h=this.renderPartial(f,b,c,d):"&"===g?h=this.unescapedValue(f,b):"name"===g?h=this.escapedValue(f,b):"text"===g&&(h=this.rawValue(f)),void 0!==h&&(e+=h);return e},w.prototype.renderSection=function(a,b,e,f){function j(a){return g.render(a,b,e)}var g=this,h="",i=b.lookup(a[1]);if(i){if(c(i))for(var k=0,l=i.length;l>k;++k)h+=this.renderTokens(a[4],b.push(i[k]),e,f);else if("object"==typeof i||"string"==typeof i||"number"==typeof i)h+=this.renderTokens(a[4],b.push(i),e,f);else if(d(i)){if("string"!=typeof f)throw new Error("Cannot use higher-order sections without the original template");i=i.call(b.view,f.slice(a[3],a[5]),j),null!=i&&(h+=i)}else h+=this.renderTokens(a[4],b,e,f);return h}},w.prototype.renderInverted=function(a,b,d,e){var f=b.lookup(a[1]);return!f||c(f)&&0===f.length?this.renderTokens(a[4],b,d,e):void 0},w.prototype.renderPartial=function(a,b,c){if(c){var e=d(c)?c(a[1]):c[a[1]];return null!=e?this.renderTokens(this.parse(e),b,c,e):void 0}},w.prototype.unescapedValue=function(a,b){var c=b.lookup(a[1]);return null!=c?c:void 0},w.prototype.escapedValue=function(b,c){var d=c.lookup(b[1]);return null!=d?a.escape(d):void 0},w.prototype.rawValue=function(a){return a[1]},a.name="mustache.js",a.version="2.1.2",a.tags=["{{","}}"];var x=new w;return a.clearCache=function(){return x.clearCache()},a.parse=function(a,b){return x.parse(a,b)},a.render=function(a,b,c){return x.render(a,b,c)},a.to_html=function(b,c,e,f){var g=a.render(b,c,e);return d(f)?(f(g),void 0):g},a.escape=l,a.Scanner=u,a.Context=v,a.Writer=w,a});